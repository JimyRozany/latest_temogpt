// ==============================
// Prisma Generator
// ==============================
generator client {
  provider = "prisma-client-js"
}

// ==============================
// Database
// ==============================
datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ==============================
// Enums
// ==============================
enum Role {
  ADMIN
  STUDENT
  CHAT_STUDENT
}

enum QuestionType {
  MCQ
  ESSAY
}

// ==============================
// User
// ==============================
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  username  String   @unique
  password  String
  role      Role     @default(STUDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  articles     Article[]
  answers      Answer[]
  examResults  ExamResult[]
  chatSessions ChatSession[]
}

// ==============================
// Article (Learning Content)
// ==============================
model Article {
  id        Int      @id @default(autoincrement())
  title     String
  body      String
  authorId  Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  author User @relation(fields: [authorId], references: [id], onDelete: Cascade)
}

// ==============================
// Subject (HTML, PHP, etc.)
// ==============================
model Subject {
  id   Int    @id @default(autoincrement())
  name String @unique

  exams Exam[]
}

// ==============================
// Exam
// ==============================
model Exam {
  id        Int      @id @default(autoincrement())
  title     String
  subjectId Int
  passScore Int
  isOpen    Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subject   Subject      @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  questions Question[]
  results   ExamResult[]
}

// ==============================
// Question (MCQ + Essay)
// ==============================
model Question {
  id        Int          @id @default(autoincrement())
  examId    Int
  text      String
  type      QuestionType
  degree    Int
  createdAt DateTime     @default(now())
  updatedAt DateTime     @updatedAt

  exam    Exam     @relation(fields: [examId], references: [id], onDelete: Cascade)
  options Option[]
  answers Answer[]
}

// ==============================
// Option (for MCQ)
// ==============================
model Option {
  id         Int     @id @default(autoincrement())
  questionId Int
  text       String
  isCorrect  Boolean @default(false)

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// ==============================
// Answer (Student Answer)
// ==============================
model Answer {
  id         Int      @id @default(autoincrement())
  userId     Int
  questionId Int
  text       String
  degree     Int? // null until graded
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@unique([userId, questionId])
}

// ==============================
// Exam Result (Final Grade)
// ==============================
model ExamResult {
  id       Int      @id @default(autoincrement())
  userId   Int
  examId   Int
  score    Int
  passed   Boolean
  gradedAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  exam Exam @relation(fields: [examId], references: [id], onDelete: Cascade)

  @@unique([userId, examId])
}

// ==============================
// Chat (ChatGPT Learning)
// ==============================
model ChatSession {
  id        Int      @id @default(autoincrement())
  userId    Int
  createdAt DateTime @default(now())

  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages ChatMessage[]
}

model ChatMessage {
  id        Int      @id @default(autoincrement())
  sessionId Int
  role      String // "user" | "assistant"
  content   String
  createdAt DateTime @default(now())

  session ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
}
